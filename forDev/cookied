#!/bin/bash
#
#       /etc/rc.d/init.d/cookied
# cookied  This shell script takes care of starting and stopping
#               cookieDaemon (the IGSPnet cookie daemon)
#
# Author: Rob Wagner
#
# chkconfig: 35 20 80
# description: cookieDaemon is the service that connects to IGSPnet \
# and is used by verifyCookie to communicate with Oracle.
#
# known bug: hangs ssh on exit (https://bugzilla.mindrot.org/show_bug.cgi?id=52)

# Source function library.
. /etc/init.d/functions

COOKIEDAEMON_DIR=/var/system/cookied

start() {
        echo -n "Starting IGSPnet cookieDaemon: "
        PID=`pgrep cookieDaemon`
        if [[ ! -z $PID ]]; then
                echo cookieDaemon already running: $PID
                exit 2;
        else
                cd $COOKIEDAEMON_DIR
                if [ ! -e "$COOKIEDAEMON_DIR/cookieDaemon" ]; then
                   echo cookieDaemon not found
                   exit 2;
                fi
                DAEMON_USER=`ls -l "$COOKIEDAEMON_DIR/cookieDaemon" | awk '{print $3;}'`
                daemon --user=$DAEMON_USER "$COOKIEDAEMON_DIR/cookieDaemon &"
                RETVAL=$?
                echo
                [ $RETVAL -eq 0 ] && touch /var/lock/subsys/cookieDaemon
                return $RETVAL
        fi

}

stop() {
        echo -n "Shutting down IGSPnet cookieDaemon: "
        echo
        killproc cookieDaemon
        echo
        rm -f /var/lock/subsys/cookieDaemon
        return 0
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop
        start
        ;;
    *)
        echo "Usage:  {start|stop|restart}"
        exit 1
        ;;
esac
exit $?

